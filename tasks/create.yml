---
# -------------------------
# Create User â€” Secure Interactive Mode
# -------------------------

# -------------------------
# Check if user already exists (clean version)
# -------------------------
- name: Check if user exists
  command: id "{{ target_username }}"
  register: user_check
  changed_when: false
  failed_when: false


- name: Abort if user already exists
  fail:
    msg: "User '{{ target_username }}' already exists. Aborting."
  when: user_check.rc == 0


# -------------------------
# Ensure allowed groups exist (create if missing)
# -------------------------
- name: Create allowed groups
  group:
    name: "{{ item.name }}"
    gid: "{{ item.gid | default(omit) }}"
    state: present
  loop: "{{ allowed_groups }}"


# -------------------------
# Gather system groups
# -------------------------
- name: Gather system groups
  getent:
    database: group


# -------------------------
# Validate allowed groups exist in system
# -------------------------
- name: Validate allowed groups in OS
  assert:
    that:
      - item.name in ansible_facts.getent_group.keys()
    fail_msg: "Group '{{ item.name }}' does not exist on system"
  loop: "{{ allowed_groups }}"


# -------------------------
# Build allowed group name list
# -------------------------
- name: Extract allowed group names
  set_fact:
    allowed_group_names: "{{ allowed_groups | map(attribute='name') | list }}"


# -------------------------
# INTERACTIVE INPUTS
# -------------------------

# -------------------------
# Prompt for primary group
# -------------------------
- name: Ask desired primary group
  pause:
    prompt: "Enter primary group ({{ allowed_group_names | join(', ') }}) [default: {{ primary_group }}]"
  register: group_input

- name: Set chosen primary group
  set_fact:
    chosen_primary_group: >-
      {{
        (group_input.user_input | trim)
        if (group_input.user_input | trim | length > 0)
        else primary_group
      }}

- name: Validate chosen primary group
  assert:
    that:
      - chosen_primary_group in allowed_group_names
    fail_msg: "Group '{{ chosen_primary_group }}' is not allowed"


# -------------------------
# Account expiration (REQUIRED)
# -------------------------
- name: Ask account expiration days
  pause:
    prompt: "Enter account expiration days from now (0 = infinite, REQUIRED)"
  register: expire_input

- name: Validate account expiration
  assert:
    that:
      - expire_input.user_input | trim | length > 0
      - expire_input.user_input is match('^[0-9]+$')
    fail_msg: "Account expiration must be numeric (0 allowed)"

- name: Compute expiration epoch
  set_fact:
    account_expires_epoch: >-
      {{
        (ansible_date_time.epoch | int)
        + ((expire_input.user_input | int) * 86400)
      }}
  when: expire_input.user_input | int > 0


# -------------------------
# PASSWORD COLLECTION
# -------------------------

- name: Collect password securely
  include_tasks: tasks/shared/password.yml


# -------------------------
# CREATE USER
# -------------------------

- name: Create user
  user:
    name: "{{ target_username }}"
    state: present
    password: "{{ encrypted_password | default(omit) }}"
    update_password: always
    shell: "{{ user_conf_default.shell }}"
    comment: "{{ user_conf_default.comment }}"
    create_home: "{{ user_conf_default.create_home }}"
    home: "{{ user_conf_default.home_dir }}"
    system: "{{ user_conf_default.system_user }}"
    uid: "{{ user_conf_default.uid | default(omit) }}"
    expires: "{{ account_expires_epoch | default(omit) }}"
    group: "{{ chosen_primary_group }}"
    groups: "{{ secondary_groups | default([]) }}"
    append: true
  register: user_create_result


# -------------------------
# Set home directory permissions
# -------------------------
- name: Set home directory permissions
  file:
    path: "{{ user_conf_default.home_dir }}"
    owner: "{{ target_username }}"
    group: "{{ chosen_primary_group }}"
    mode: "{{ user_conf_default.home_permissions }}"
  when: user_conf_default.create_home


# -------------------------
# PASSWORD AGING POLICY
# -------------------------
- name: Set password aging policy (including inactive)
  command: >
    chage -M {{ security.password.max_days }}
           -m {{ security.password.min_days }}
           -W {{ security.password.warn_days }}
           -I {{ security.password.inactive_days }}
           {{ target_username }}
  changed_when: true