---
# -------------------------
# Ask password method
# -------------------------
- name: Ask password method
  pause:
    prompt: |
      Password options:
      1. Generate random password
      2. Enter password manually
      3. Lock account (no password)
      Choose (1-3):
  register: password_method_input

- name: Set password method fact
  set_fact:
    password_method: "{{ password_method_input.user_input | default('1') | trim }}"

- name: Validate password method choice
  assert:
    that:
      - password_method in ['1','2','3']
    fail_msg: "Invalid choice. Must be 1, 2, or 3."

# -------------------------
# Generate password (method 1)
# -------------------------
- name: Generate random password
  shell: "openssl rand -hex {{ user_conf_default.password_min_length }}"
  register: random_pass
  changed_when: false
  when: password_method == '1'

# -------------------------
# Manual password (method 2)
# -------------------------
- name: Ask manual password
  pause:
    prompt: "Enter password (min {{ user_conf_default.password_min_length }} chars):"
    echo: false
  register: manual_pass_input
  when: password_method == '2'

- name: Set manual password fact
  set_fact:
    manual_password: "{{ manual_pass_input.user_input }}"
  when: password_method == '2'
  no_log: true

- name: Validate manual password length
  fail:
    msg: "Password too short"
  when:
    - password_method == '2'
    - manual_password | length < user_conf_default.password_min_length

# -------------------------
# Build plaintext password
# -------------------------
- name: Set password_plain fact
  set_fact:
    password_plain: >-
      {{
        random_pass.stdout if password_method == '1'
        else (manual_password if password_method == '2'
        else '')
      }}
  no_log: true

# -------------------------
# Hash password
# -------------------------
- name: Set encrypted password
  set_fact:
    encrypted_password: "{{ password_plain | password_hash(security.password.hash_algo) }}"
  when: password_method in ['1','2']
  no_log: true

# -------------------------
# Locked account (method 3)
# -------------------------
- name: Set locked account password marker
  set_fact:
    encrypted_password: "!"
  when: password_method == '3'

- name: Set account lock flag
  set_fact:
    account_locked: "{{ password_method == '3' }}"

# -------------------------
# Save generated password to control-node audit file
# -------------------------
- name: Save generated password to local audit file
  delegate_to: localhost
  become: false
  lineinfile:
    path: "{{ playbook_dir }}/generated_passwords.txt"
    regexp: "^{{ inventory_hostname }}\\s+{{ target_username }}\\s+"
    line: "{{ inventory_hostname }} {{ target_username }} {{ password_plain }}"
    create: true
    mode: '0600'
  when: password_method == '1'
  no_log: true

