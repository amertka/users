---
# -------------------------------------------------
# SSH Key Management for target user
# -------------------------------------------------

# Check user exists
- name: Check if user exists
  ansible.builtin.getent:
    database: passwd
    key: "{{ target_username }}"
  register: user_check
  ignore_errors: yes

- name: Stop if user does not exist
  ansible.builtin.fail:
    msg: "User '{{ target_username }}' does not exist."
  when: user_check.ansible_facts.getent_passwd[target_username] is not defined

# Get home directory
- name: Set user home directory
  set_fact:
    user_home: "{{ user_check.ansible_facts.getent_passwd[target_username][4] }}"

# SSH menu
- name: SSH key menu
  pause:
    prompt: |
      ===================================
      SSH Key Management for '{{ target_username }}'
      1. Add SSH key
      2. Remove SSH key
      3. List SSH keys
      4. Replace all keys
      5. View fingerprints
      ===================================
      Choose action (1-5)
  register: ssh_action_input

- set_fact:
    ssh_action: "{{ ssh_action_input.user_input }}"

- name: Validate choice
  fail:
    msg: "Invalid choice '{{ ssh_action }}'"
  when: ssh_action not in ['1','2','3','4','5']

# Ensure .ssh dir if needed
- name: Ensure .ssh directory
  file:
    path: "{{ user_home }}/.ssh"
    state: directory
    owner: "{{ target_username }}"
    mode: '0700'
  when: ssh_action in ['1','4']

# Ask for key if needed
- name: Ask for SSH key
  pause:
    prompt: "Enter SSH public key"
  register: ssh_public_key_input
  when: ssh_action in ['1','2','4']

- set_fact:
    ssh_public_key: "{{ ssh_public_key_input.user_input }}"
  when: ssh_action in ['1','2','4']

# Operations
- block:

    - name: Add key
      authorized_key:
        user: "{{ target_username }}"
        key: "{{ ssh_public_key }}"
        state: present
      when: ssh_action == '1'

    - name: Remove key
      authorized_key:
        user: "{{ target_username }}"
        key: "{{ ssh_public_key }}"
        state: absent
      when: ssh_action == '2'

    - name: List keys
      command: cat {{ user_home }}/.ssh/authorized_keys
      register: ssh_list
      ignore_errors: yes
      changed_when: false
      when: ssh_action == '3'

    - debug:
        msg: "{{ ssh_list.stdout_lines | default(['No keys found']) }}"
      when: ssh_action == '3'

    - name: Replace keys
      copy:
        dest: "{{ user_home }}/.ssh/authorized_keys"
        content: "{{ ssh_public_key }}"
        owner: "{{ target_username }}"
        mode: '0600'
      when: ssh_action == '4'

    - name: Fingerprints
      shell: |
        if [ -f "{{ user_home }}/.ssh/authorized_keys" ]; then
          awk 'NF' "{{ user_home }}/.ssh/authorized_keys" | ssh-keygen -lf -
        else
          echo "No SSH keys found"
        fi
      register: ssh_fingerprints
      changed_when: false
      when: ssh_action == '5'

    - debug:
        msg: "{{ ssh_fingerprints.stdout_lines }}"
      when: ssh_action == '5'
